"use strict";const t=Object.freeze({childList:!0,subtree:!0});async function e(t,e=null){return new Promise((n=>{chrome.storage[t].get(e,(t=>{n(e?t[e]:t)}))}))}const n={buttonSettings:".ytp-settings-button",pathSizeToggle:'path[d*="m 28,"], path[d*="m 26,"]',optionQuality:".ytp-menuitem:last-child",menuOption:".ytp-menuitem",menuOptionContent:".ytp-menuitem-content",panelMenu:".ytp-panel-menu",panelHeader:".ytp-panel-header button",settingsMenu:".ytp-settings-menu",player:".html5-video-player",video:"video"};function i(t){return[...document.querySelectorAll(n[t])].find(o)}function o(t){return t?.offsetWidth>0&&t?.offsetHeight>0}const c=[4320,2160,1440,1080,720,480,360,240,144].find((t=>t<=screen.height)),r={60:c,50:c,30:c},a=!1,u=1;function s(){const t=document.cookie.match(/wide=([10])/);return t?Number(t[1]):0}async function l(t){const i=document.querySelector(n.pathSizeToggle);if(!i)return;const o=n.menuOption,c=i.closest(`button, ${o}`);if(!(await e("sync","autoResize")??a))return;const r=t||(await e("sync","size")??u);if(s()!==r)for(;await new Promise((t=>setTimeout(t,100))),s()!==r;)c.click()}let d,y={...r};function p(t){const e=Boolean(t.textContent.match(/\d/)),n=t.children.length>1;return e&&!n}function f(){return[...i("player").querySelectorAll(n.menuOption)].filter(p)}function m(t){return parseInt(t.textContent)}async function h(t){const n=function(){const t=f()[0]?.textContent;if(!t)return 30;const e=t.match(/[ps](\d+)/);return e?Number(e[1]):30}(),i=f().map(m),o=f(),c=await async function(){try{const t=await e("local","qualities")??{};return y={...r,...t},y}catch{return y}}(),a=await function(t,e){const n=Object.keys(t).map(Number).sort(((t,e)=>e-t));for(;n.length>1;){const t=n.pop();if(e<=t)return t}return n[0]}(c,n),u=(s=i,l=t||c[a],s.findIndex((t=>t===l)));var s,l;if(u>-1)o[u].click();else if(function(t,e){if(!t)return!0;const n=t.textContent;return parseInt(n)<e}(o[0],c[a]))o[0]?.click();else{const t=i.findIndex((t=>t<=c[a]));t>-1&&o[t].click()}}async function w(){const t=i("video");!function(){const t=i("player").querySelector(n.optionQuality);if(!t)return!1;const e=t.querySelector(n.menuOptionContent)?.textContent?.match(/\d+/);return!!e&&e[0].length>=3}()?t.addEventListener("canplay",w,{once:!0}):(i("player").querySelector(n.optionQuality).click(),await h(window.ythdLastQualityClicked))}async function v(t){await w(),function(t){t.querySelector(n.panelHeader)?.click()}(t)}async function g(){const t=i("player"),e=t.querySelector(n.buttonSettings);e&&(!function(t){const e=t.querySelector(n.panelHeader);return Boolean(e)}(t)?("true"!==i("buttonSettings")?.ariaExpanded&&e.click(),e.click(),await v(t)):await v(t))}chrome.storage.onChanged.addListener((async({qualities:t,autoResize:n,size:i})=>{if(t)return window.ythdLastQualityClicked=null,y={...t.newValue},void await g();if(n&&n.newValue){const t=await e("sync","size");await l(t)}else if(void 0!==i){const t=i.newValue;await l(t)}})),window.ythdLastQualityClicked=null;let b=document.title;function k({target:t,isTrusted:e}){if(!e)return;const n=t,i=n.matches("span")?n:n.matches("div")?n.querySelector("span"):null,o=parseInt(i?.textContent);isNaN(o)||(window.ythdLastQualityClicked=o)}const S=/ytp-tooltip-title|ytp-time-current|ytp-bound-time-right/;function C(){if(b===document.title)return;b=document.title;const e=i("player")||document;d||(d=new MutationObserver((t=>{const e=i("video");!(t=>{const e=t[t.length-1].target;return Boolean(e.className.match(S))})(t)&&e&&(l(),window.ythdLastQualityClicked=null,g(),e.removeEventListener("canplay",g),e.addEventListener("canplay",g),d.disconnect())}))),d.observe(e,t)}new MutationObserver(((e,n)=>{const o=i("video"),c=i("player");if(!o||!c)return;n.disconnect(),c.addEventListener("click",k);if(!location.pathname.startsWith("/embed/"))return g(),l(),o.addEventListener("canplay",g),void new MutationObserver(C).observe(document.querySelector("title"),t);o.paused||g(),o.addEventListener("canplay",g)})).observe(document,t);
